<?php
/**
 * This file is part of CodeBeast.
 *
 * (c) Sebastian Feldmann <sf@sebastian.feldmann.info>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */
namespace EugeneZenko\CodeBeast\Runner;

use EugeneZenko\CodeBeast\Runner;
use EugeneZenko\CodeBeast\Console\IOUtil;

class Installer extends Runner
{
    /**
     * Execute installation.
     */
    public function run()
    {
        $path = $this->getHookSettings();

        if (empty($path)) {
            $path = $this->io->ask('  <info>Path to git hook settings</info> <comment>pre-commit.settings file generated by codebeast</comment> ', '');
            $path = trim($path);
            if (!empty($path)) {
                if (!file_exists($path)) {
                    $path = '';
                }
            }
        }

        if (empty($path)) {
            $this->io->writeError('<info>Cannot locate hook file </info>');
            exit;
        }

        $hook = file_get_contents($path);
        $vendor_path = $this->io->ask('  <info>Path to vendor folder</info> <comment>Skip trailing slash</comment> ', '');
        $hook = str_replace('%vendor%', $vendor_path, $hook);

        $directory = $this->detectGitFolder();

        if (empty($directory)) {
            $dir = $this->io->ask('  <info>Path to .git folder</info>', 'Skip trailing slash');
            $dir = trim($dir);
            if (!empty($dir) && is_dir($dir)) {
                $directory = $dir;
            }
        }

        if (empty($directory)) {
            $this->io->writeError('<info>Cannot locate directory </info>');
            exit;
        }

        $dest = $directory . '/hooks/pre-commit';
        $result = file_put_contents($dest, $hook);
        $writable = chmod($dest, 0755);
        if ($result && $writable) {
            $this->io->write('<info>Hook installed</info>');
        } else {
            $this->io->writeError('<info>Cannot install hook </info>');
        }
    }

    protected function getHookSettings() {
        $initial_cwd = preg_replace( '~(\w)$~' , '$1' . DIRECTORY_SEPARATOR , realpath( getcwd() ) );
        $guess_file = $initial_cwd . 'pre-commit.settings';

        if (file_exists($guess_file)) {
            $use = $this->io->ask('  <info>Do you want to use autodetected file?</info> <comment>' . $guess_file . ' [ y, n ]</comment> ', '');
            if (IOUtil::answerToBool($use)) {
                return $guess_file;
            }
        }

        return '';
    }

    protected function detectGitFolder() {
        $initial_cwd = preg_replace( '~(\w)$~' , '$1' . DIRECTORY_SEPARATOR , realpath( getcwd() ) );
        $guess_dir = $initial_cwd . '.git';
        if (file_exists($guess_dir)) {
            $use = $this->io->ask('  <info>Do you want to use autodetected .git dir?</info> <comment>' . $guess_dir . ' [ y, n ]</comment> ', '');
            if (IOUtil::answerToBool($use)) {
                return $guess_dir;
            }
        }

        return '';
    }
}
